<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechFix - Gest√£o de Assist√™ncia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos de Impress√£o */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden">

    <!-- √Årea de Impress√£o (Invis√≠vel normalmente) -->
    <div id="printable-area" class="hidden bg-white text-black p-8">
        <!-- O conte√∫do a ser impresso ser√° injetado aqui via JS -->
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col hidden md:flex no-print">
        <div class="p-6 flex items-center gap-3 border-b border-slate-700">
            <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-wrench"></i></div>
            <h1 class="text-xl font-bold">TechFix</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showPage('dashboard')" class="w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                <i class="fas fa-chart-line w-6"></i> Vis√£o Geral
            </button>
            <button onclick="showPage('clients')" class="w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                <i class="fas fa-users w-6"></i> Clientes
            </button>
            <button onclick="showPage('orders')" class="w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                <i class="fas fa-laptop-medical w-6"></i> Ordens (OS)
            </button>
            <hr class="border-slate-700 my-2">
            <button onclick="showPage('settings')" class="w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition text-slate-400 hover:text-white">
                <i class="fas fa-cog w-6"></i> Configura√ß√µes
            </button>
        </nav>
    </aside>

    <!-- Mobile Header -->
    <div class="md:hidden fixed w-full bg-slate-900 text-white z-50 p-4 flex justify-between items-center no-print">
        <div class="flex items-center gap-2">
            <i class="fas fa-wrench text-blue-500"></i> <span class="font-bold">TechFix</span>
        </div>
        <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"><i class="fas fa-bars"></i></button>
    </div>
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden fixed top-14 left-0 w-full bg-slate-800 text-white z-40 p-4 shadow-lg md:hidden no-print">
        <button onclick="showPage('dashboard'); toggleMobileMenu()" class="block w-full text-left p-3 border-b border-slate-700">Vis√£o Geral</button>
        <button onclick="showPage('clients'); toggleMobileMenu()" class="block w-full text-left p-3 border-b border-slate-700">Clientes</button>
        <button onclick="showPage('orders'); toggleMobileMenu()" class="block w-full text-left p-3 border-b border-slate-700">Ordens (OS)</button>
        <button onclick="showPage('settings'); toggleMobileMenu()" class="block w-full text-left p-3 text-gray-400">Configura√ß√µes</button>
    </div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-auto pt-16 md:pt-0 no-print">
        <header class="bg-white p-6 shadow-sm flex justify-between items-center">
            <h2 id="page-title" class="text-2xl font-bold text-gray-700">Vis√£o Geral</h2>
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">TF</div>
        </header>

        <div class="p-6 flex-1 overflow-auto">
            
            <!-- PAGINA: DASHBOARD -->
            <div id="dashboard" class="page fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                        <div>
                            <p class="text-gray-500">Ordens Abertas</p>
                            <p class="text-3xl font-bold" id="dash-open-count">0</p>
                        </div>
                        <i class="fas fa-clipboard-list text-3xl text-blue-200"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex justify-between items-center">
                        <div>
                            <p class="text-gray-500">Prontos</p>
                            <p class="text-3xl font-bold" id="dash-ready-count">0</p>
                        </div>
                        <i class="fas fa-check-circle text-3xl text-green-200"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500 flex justify-between items-center">
                        <div>
                            <p class="text-gray-500">Clientes</p>
                            <p class="text-3xl font-bold" id="dash-client-count">0</p>
                        </div>
                        <i class="fas fa-users text-3xl text-purple-200"></i>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 text-center">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">Bem-vindo ao TechFix</h3>
                    <p class="text-blue-600">Configure os dados da sua empresa no menu "Configura√ß√µes" para personalizar os relat√≥rios.</p>
                    <button onclick="showPage('orders')" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                        Come√ßar Agora
                    </button>
                </div>
            </div>

            <!-- PAGINA: CLIENTES -->
            <div id="clients" class="page hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-lg font-semibold w-full md:w-auto">Lista de Clientes</h3>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <div class="relative">
                            <input type="text" id="search-client" oninput="renderClients()" placeholder="Buscar nome, CPF, email..." class="w-full md:w-64 pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                        </div>
                        <button onclick="openClientModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i> Novo Cliente
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 w-1/4">Nome</th>
                                <th class="p-4 hidden md:table-cell">CPF/CNPJ</th>
                                <th class="p-4 w-1/4">Telefone</th>
                                <th class="p-4 hidden md:table-cell">Email</th>
                                <th class="p-4 text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="clients-list" class="divide-y"></tbody>
                    </table>
                    <p id="no-clients-msg" class="p-8 text-center text-gray-400">Nenhum cliente cadastrado.</p>
                </div>
            </div>

            <!-- PAGINA: ORDENS -->
            <div id="orders" class="page hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-lg font-semibold w-full md:w-auto">Ordens de Servi√ßo</h3>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <div class="relative">
                            <input type="text" id="search-order" oninput="renderOrders()" placeholder="Buscar OS, Cliente, Serial..." class="w-full md:w-64 pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                        </div>
                        <button onclick="openOrderModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i> Nova OS
                        </button>
                    </div>
                </div>
                <div id="orders-list" class="grid grid-cols-1 gap-4"></div>
                <p id="no-orders-msg" class="p-8 text-center text-gray-400 hidden">Nenhuma ordem encontrada.</p>
            </div>

            <!-- PAGINA: CONFIGURA√á√ïES E DADOS -->
            <div id="settings" class="page hidden fade-in space-y-8">
                
                <!-- Dados da Empresa -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-800">
                        <i class="fas fa-building text-blue-600"></i> Dados da Empresa (Para o Relat√≥rio)
                    </h3>
                    <form onsubmit="saveCompanySettings(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome da Empresa</label>
                                <input type="text" id="conf-company-name" class="w-full p-2 border rounded" placeholder="Ex: TechFix Inform√°tica">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Telefone / Contato</label>
                                <input type="text" id="conf-company-phone" class="w-full p-2 border rounded" placeholder="Ex: (00) 9999-9999">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Endere√ßo Completo</label>
                            <input type="text" id="conf-company-address" class="w-full p-2 border rounded" placeholder="Rua Exemplo, 123 - Centro">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Mensagem de Rodap√©</label>
                            <input type="text" id="conf-company-footer" class="w-full p-2 border rounded" placeholder="Ex: Agradecemos a prefer√™ncia! Garantia de 90 dias.">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">Salvar Dados da Empresa</button>
                    </form>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Backup -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg mb-2 text-indigo-600"><i class="fas fa-download mr-2"></i>Backup</h4>
                        <p class="text-gray-600 text-sm mb-4">Baixe seus dados para n√£o perder nada.</p>
                        <button onclick="downloadBackup()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 font-bold">Baixar Dados</button>
                    </div>
                    <!-- Restaurar -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg mb-2 text-orange-600"><i class="fas fa-upload mr-2"></i>Restaurar</h4>
                        <p class="text-gray-600 text-sm mb-4">Recupere dados de um arquivo salvo.</p>
                        <input type="file" id="file-input" class="hidden" onchange="restoreBackup(this)">
                        <button onclick="document.getElementById('file-input').click()" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700 font-bold">Selecionar Arquivo</button>
                    </div>
                </div>

                <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                    <button onclick="clearAllData()" class="text-red-600 font-bold text-sm hover:underline">Apagar todos os dados e resetar</button>
                </div>
            </div>

        </div>
    </main>

    <!-- MODAL: CLIENTE (NOVO / EDITAR) -->
    <div id="modal-client" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold" id="modal-client-title">Novo Cliente</h3>
                <button onclick="toggleModal('modal-client')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-client" onsubmit="saveClient(event)" class="p-6 space-y-4">
                <input type="text" id="client-name" placeholder="Nome Completo" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="text" id="client-document" placeholder="CPF ou CNPJ" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="text" id="client-phone" placeholder="Telefone / WhatsApp" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="email" id="client-email" placeholder="Email (Opcional)" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">Salvar Cliente</button>
            </form>
        </div>
    </div>

    <!-- MODAL: ORDEM (NOVA / EDITAR) -->
    <div id="modal-order" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold" id="modal-order-title">Nova Ordem de Servi√ßo</h3>
                <button onclick="toggleModal('modal-order')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-order" onsubmit="saveOrder(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Cliente</label>
                    <select id="order-client" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="order-device" placeholder="Modelo do Notebook" required class="w-full p-2 border rounded">
                    <input type="text" id="order-serial" placeholder="N¬∫ S√©rie (Opcional)" class="w-full p-2 border rounded">
                </div>
                <textarea id="order-defect" rows="2" placeholder="Descri√ß√£o do Defeito..." required class="w-full p-2 border rounded"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="order-accessories" placeholder="Acess√≥rios (Fonte, Mouse...)" class="w-full p-2 border rounded">
                    <input type="text" id="order-password" placeholder="Senha do Sistema" class="w-full p-2 border rounded">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">Salvar Ordem</button>
            </form>
        </div>
    </div>

    <!-- MODAL: OR√áAMENTO -->
    <div id="modal-budget" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden">
            <div class="bg-yellow-50 p-4 border-b border-yellow-100 flex justify-between items-center">
                <h3 class="font-bold text-yellow-800"><i class="fas fa-file-invoice-dollar mr-2"></i>Fazer Or√ßamento</h3>
                <button onclick="toggleModal('modal-budget')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-500">Defina os valores e envie para o cliente.</p>
                <div>
                    <label class="block text-sm font-medium mb-1">Servi√ßo a ser realizado</label>
                    <input type="text" id="budget-service" placeholder="Ex: Troca de Tela, Formata√ß√£o..." class="w-full p-2 border rounded focus:ring-2 focus:ring-yellow-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Valor Total (R$)</label>
                    <input type="text" id="budget-value" placeholder="Ex: 350,00" class="w-full p-2 border rounded focus:ring-2 focus:ring-yellow-500 outline-none font-bold text-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Observa√ß√µes do Or√ßamento</label>
                    <textarea id="budget-notes" rows="3" placeholder="Ex: Pe√ßa sob encomenda, prazo de 3 dias..." class="w-full p-2 border rounded focus:ring-2 focus:ring-yellow-500 outline-none"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="saveBudget()" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300 font-bold">
                        Apenas Salvar
                    </button>
                    <button onclick="saveAndSendBudget()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold flex justify-center items-center gap-2">
                        <i class="fab fa-whatsapp"></i> Salvar e Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: SUCESSO DA ORDEM -->
    <div id="modal-success" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden text-center p-6">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-3xl">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">OS Salva com Sucesso!</h3>
            <p class="text-gray-600 mb-6">O que deseja fazer agora?</p>
            
            <div class="space-y-3">
                <button id="btn-print-now" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 flex items-center justify-center gap-2">
                    <i class="fas fa-print"></i> Imprimir Relat√≥rio
                </button>
                <button id="btn-whatsapp-now" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> Enviar no WhatsApp
                </button>
                <button onclick="toggleModal('modal-success')" class="w-full text-gray-500 py-2 hover:text-gray-700">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GERENCIAMENTO DE DADOS (LOCALSTORAGE) ---
        const DB_KEY = 'techfix_data_v3';
        
        // Vari√°veis para controlar Edi√ß√£o
        let editingClientId = null;
        let editingOrderId = null;
        let currentBudgetOrderId = null;

        const initialData = {
            clients: [],
            orders: [],
            company: {
                name: 'Infosupri - RD suprimentos de informatica LTDA',
                phone: '3021-5940',
                address: 'Rua Rep√∫blica da Arm√™nia, 1312 - CNPJ: 07.079.968/0001-02',
                footer: 'Obrigado pela prefer√™ncia!'
            }
        };

        let db = JSON.parse(localStorage.getItem(DB_KEY));
        
        if (!db) {
            const oldDbV2 = JSON.parse(localStorage.getItem('techfix_data_v2'));
            const oldDbV1 = JSON.parse(localStorage.getItem('techfix_data_v1'));
            
            if(oldDbV2) {
                db = { ...initialData, clients: oldDbV2.clients, orders: oldDbV2.orders };
            } else if(oldDbV1) {
                db = { ...initialData, clients: oldDbV1.clients, orders: oldDbV1.orders };
            } else {
                db = initialData;
            }
            saveDB();
        } else if (!db.company) {
            db.company = initialData.company;
            saveDB();
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderDashboard();
        }

        // --- NAVEGA√á√ÉO ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            
            const titles = { 
                'dashboard': 'Vis√£o Geral', 
                'clients': 'Clientes', 
                'orders': 'Ordens de Servi√ßo',
                'settings': 'Configura√ß√µes'
            };
            document.getElementById('page-title').innerText = titles[pageId];
            
            if(pageId === 'clients') renderClients();
            if(pageId === 'orders') renderOrders();
            if(pageId === 'settings') loadCompanySettings();
        }

        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.add('hidden');
        }

        function toggleModal(modalId) {
            const el = document.getElementById(modalId);
            el.classList.toggle('hidden');
        }

        // --- CONFIGURA√á√ïES DA EMPRESA ---
        function loadCompanySettings() {
            document.getElementById('conf-company-name').value = db.company.name || '';
            document.getElementById('conf-company-phone').value = db.company.phone || '';
            document.getElementById('conf-company-address').value = db.company.address || '';
            document.getElementById('conf-company-footer').value = db.company.footer || '';
        }

        function saveCompanySettings(e) {
            e.preventDefault();
            db.company = {
                name: document.getElementById('conf-company-name').value,
                phone: document.getElementById('conf-company-phone').value,
                address: document.getElementById('conf-company-address').value,
                footer: document.getElementById('conf-company-footer').value
            };
            saveDB();
            alert("Dados da empresa salvos com sucesso!");
        }

        // --- L√ìGICA DE CLIENTES ---
        function openClientModal() {
            editingClientId = null; // Modo Criar
            document.getElementById('form-client').reset();
            document.getElementById('modal-client-title').innerText = "Novo Cliente";
            toggleModal('modal-client');
        }

        function editClient(id) {
            const client = db.clients.find(c => c.id === id);
            if (!client) return;

            editingClientId = id; // Modo Editar
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-phone').value = client.phone;
            document.getElementById('client-email').value = client.email;
            document.getElementById('client-document').value = client.document || '';
            
            document.getElementById('modal-client-title').innerText = "Editar Cliente";
            toggleModal('modal-client');
        }

        function deleteClient(id) {
            if(confirm('Tem certeza que deseja excluir este cliente?')) {
                db.clients = db.clients.filter(c => c.id !== id);
                saveDB();
                renderClients();
            }
        }

        function saveClient(e) {
            e.preventDefault();
            const name = document.getElementById('client-name').value;
            const phone = document.getElementById('client-phone').value;
            const email = document.getElementById('client-email').value;
            const doc = document.getElementById('client-document').value;

            if (editingClientId) {
                const index = db.clients.findIndex(c => c.id === editingClientId);
                if (index !== -1) {
                    db.clients[index] = { ...db.clients[index], name, phone, email, document: doc };
                }
            } else {
                db.clients.push({ id: Date.now(), name, phone, email, document: doc });
            }

            saveDB();
            toggleModal('modal-client');
            renderClients();
        }

        function renderClients() {
            const searchTerm = document.getElementById('search-client')?.value.toLowerCase() || '';
            const tbody = document.getElementById('clients-list');
            tbody.innerHTML = '';
            
            const filteredClients = db.clients.filter(c => 
                c.name.toLowerCase().includes(searchTerm) ||
                c.phone.includes(searchTerm) ||
                (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                (c.document && c.document.includes(searchTerm))
            );

            if (filteredClients.length === 0) {
                document.getElementById('no-clients-msg').classList.remove('hidden');
                if(searchTerm) document.getElementById('no-clients-msg').innerText = "Nenhum cliente encontrado para essa pesquisa.";
                else document.getElementById('no-clients-msg').innerText = "Nenhum cliente cadastrado.";
                return;
            }
            document.getElementById('no-clients-msg').classList.add('hidden');

            const sortedClients = [...filteredClients].sort((a,b) => a.name.localeCompare(b.name));

            sortedClients.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 border-b last:border-0';
                tr.innerHTML = `
                    <td class="p-4 font-medium">${c.name}</td>
                    <td class="p-4 hidden md:table-cell text-gray-500">${c.document || '-'}</td>
                    <td class="p-4">${c.phone}</td>
                    <td class="p-4 hidden md:table-cell text-gray-500">${c.email}</td>
                    <td class="p-4 text-right">
                        <button onclick="preSelectClient(${c.id})" class="text-blue-600 hover:text-blue-800 text-sm font-semibold mr-3" title="Abrir OS">
                            <i class="fas fa-file-alt"></i> OS
                        </button>
                        <button onclick="editClient(${c.id})" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold mr-3" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteClient(${c.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- L√ìGICA DE ORDENS ---
        function openOrderModal() {
            editingOrderId = null;
            document.getElementById('form-order').reset();
            document.getElementById('modal-order-title').innerText = "Nova Ordem de Servi√ßo";
            
            populateClientSelect();
            if (db.clients.length === 0) {
                alert("Cadastre um cliente primeiro!");
                showPage('clients');
                return;
            }
            toggleModal('modal-order');
        }

        function populateClientSelect(selectedId = null) {
            const select = document.getElementById('order-client');
            select.innerHTML = '<option value="">Selecione o Cliente...</option>';
            const sortedClients = [...db.clients].sort((a,b) => a.name.localeCompare(b.name));
            
            sortedClients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.innerText = c.name;
                if(selectedId && c.id == selectedId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function editOrder(id) {
            const order = db.orders.find(o => o.id === id);
            if (!order) return;

            editingOrderId = id;
            document.getElementById('modal-order-title').innerText = "Editar OS #" + id;

            populateClientSelect(order.clientId);
            document.getElementById('order-device').value = order.device;
            document.getElementById('order-serial').value = order.serial || '';
            document.getElementById('order-defect').value = order.defect;
            document.getElementById('order-accessories').value = order.accessories || '';
            document.getElementById('order-password').value = order.password || '';
            
            toggleModal('modal-order');
        }

        function deleteOrder(id) {
            if(confirm('Tem certeza que deseja excluir esta Ordem de Servi√ßo?')) {
                db.orders = db.orders.filter(o => o.id !== id);
                saveDB();
                renderOrders();
            }
        }

        function preSelectClient(clientId) {
            showPage('orders');
            openOrderModal();
            setTimeout(() => {
                document.getElementById('order-client').value = clientId;
            }, 50);
        }

        function saveOrder(e) {
            e.preventDefault();
            const clientId = document.getElementById('order-client').value;
            const device = document.getElementById('order-device').value;
            const defect = document.getElementById('order-defect').value;
            const accessories = document.getElementById('order-accessories').value;
            const password = document.getElementById('order-password').value;
            const serial = document.getElementById('order-serial').value;

            let savedId;

            if (editingOrderId) {
                const index = db.orders.findIndex(o => o.id === editingOrderId);
                if (index !== -1) {
                    // Mant√©m o or√ßamento existente se houver
                    const existingBudget = db.orders[index].budget || null;
                    db.orders[index] = { 
                        ...db.orders[index], 
                        clientId, device, defect, accessories, password, serial,
                        budget: existingBudget
                    };
                    savedId = editingOrderId;
                }
            } else {
                const newId = Math.floor(Math.random() * 9000) + 1000;
                savedId = newId;
                db.orders.push({
                    id: newId,
                    clientId,
                    device,
                    defect,
                    accessories,
                    password,
                    serial,
                    status: 'analise',
                    date: new Date().toLocaleDateString('pt-PT'),
                    budget: null
                });
            }

            saveDB();
            toggleModal('modal-order');
            renderOrders();

            const btnPrint = document.getElementById('btn-print-now');
            const btnWhats = document.getElementById('btn-whatsapp-now');
            
            btnPrint.onclick = () => { toggleModal('modal-success'); printOrder(savedId); };
            btnWhats.onclick = () => { toggleModal('modal-success'); sendWhatsApp(savedId); };
            
            toggleModal('modal-success');
        }

        function renderOrders() {
            const searchTerm = document.getElementById('search-order')?.value.toLowerCase() || '';
            const container = document.getElementById('orders-list');
            container.innerHTML = '';

            const filteredOrders = db.orders.filter(o => {
                const client = db.clients.find(c => c.id == o.clientId) || { name: '' };
                return (
                    o.id.toString().includes(searchTerm) ||
                    o.device.toLowerCase().includes(searchTerm) ||
                    client.name.toLowerCase().includes(searchTerm) ||
                    (o.serial && o.serial.toLowerCase().includes(searchTerm))
                );
            });

            if (filteredOrders.length === 0) {
                document.getElementById('no-orders-msg').classList.remove('hidden');
                if(searchTerm) document.getElementById('no-orders-msg').innerText = "Nenhuma ordem encontrada para essa pesquisa.";
                else document.getElementById('no-orders-msg').innerText = "Nenhuma ordem encontrada.";
                return;
            }
            document.getElementById('no-orders-msg').classList.add('hidden');

            const sortedOrders = [...filteredOrders].sort((a,b) => b.id - a.id);

            sortedOrders.forEach(o => {
                const client = db.clients.find(c => c.id == o.clientId) || { name: 'Desconhecido', phone: '-' };
                
                let statusClass = 'bg-yellow-100 text-yellow-800';
                if(o.status === 'aprovado') statusClass = 'bg-blue-100 text-blue-800';
                if(o.status === 'pronto') statusClass = 'bg-green-100 text-green-800';

                // Adicionar crach√° de or√ßamento
                const budgetBadge = o.budget ? 
                    `<span class="ml-2 bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-sm font-bold shadow-sm" title="Or√ßamento Enviado"><i class="fas fa-dollar-sign"></i></span>` 
                    : '';

                const div = document.createElement('div');
                div.className = 'bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative group';
                div.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start mb-2 gap-2">
                        <div>
                            <span class="font-bold text-lg text-slate-700">OS #${o.id}</span>
                            ${budgetBadge}
                            <span class="text-xs text-gray-400 ml-2">${o.date}</span>
                        </div>
                        <div class="flex gap-2 flex-wrap items-center">
                             <button onclick="openBudgetModal(${o.id})" class="text-yellow-600 hover:text-yellow-800 border border-yellow-200 bg-yellow-50 px-3 py-1 rounded text-xs flex items-center gap-1 font-bold" title="Or√ßamento">
                                <i class="fas fa-file-invoice-dollar"></i> Or√ßamento
                            </button>
                             <button onclick="sendWhatsApp(${o.id})" class="text-green-600 hover:text-green-800 border border-green-200 bg-green-50 px-2 py-1 rounded text-xs flex items-center gap-1" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                             <button onclick="printOrder(${o.id})" class="text-slate-500 hover:text-slate-800 border px-2 py-1 rounded text-xs flex items-center gap-1" title="Imprimir">
                                <i class="fas fa-print"></i>
                            </button>
                            <select onchange="updateStatus(${o.id}, this.value)" class="text-xs p-1 rounded border ${statusClass}">
                                <option value="analise" ${o.status === 'analise' ? 'selected' : ''}>Em An√°lise</option>
                                <option value="aprovado" ${o.status === 'aprovado' ? 'selected' : ''}>Aprovado</option>
                                <option value="pronto" ${o.status === 'pronto' ? 'selected' : ''}>Pronto</option>
                            </select>
                            
                            <div class="ml-2 pl-2 border-l border-slate-200 flex gap-2">
                                <button onclick="editOrder(${o.id})" class="text-indigo-400 hover:text-indigo-600" title="Editar OS">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button onclick="deleteOrder(${o.id})" class="text-red-300 hover:text-red-500" title="Excluir OS">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h4 class="font-bold text-blue-600"><i class="fas fa-laptop mr-1"></i> ${o.device}</h4>
                        <p class="text-sm text-gray-600">Cliente: <b>${client.name}</b></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 space-y-1">
                        <p><strong>Defeito:</strong> ${o.defect}</p>
                        ${o.budget ? `<p class="text-yellow-700 font-medium"><i class="fas fa-tag mr-1"></i>Or√ßamento: R$ ${o.budget.value}</p>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStatus(id, newStatus) {
            const order = db.orders.find(o => o.id == id);
            if(order) {
                order.status = newStatus;
                saveDB();
                renderDashboard();
                renderOrders();
            }
        }

        // --- L√ìGICA DE OR√áAMENTO ---
        function openBudgetModal(orderId) {
            currentBudgetOrderId = orderId;
            const order = db.orders.find(o => o.id == orderId);
            
            // Preenche se j√° existir
            if(order.budget) {
                document.getElementById('budget-service').value = order.budget.service || '';
                document.getElementById('budget-value').value = order.budget.value || '';
                document.getElementById('budget-notes').value = order.budget.notes || '';
            } else {
                document.getElementById('budget-service').value = '';
                document.getElementById('budget-value').value = '';
                document.getElementById('budget-notes').value = '';
            }
            
            toggleModal('modal-budget');
        }

        function saveBudget() {
            if(!currentBudgetOrderId) return;
            const service = document.getElementById('budget-service').value;
            const value = document.getElementById('budget-value').value;
            const notes = document.getElementById('budget-notes').value;

            const index = db.orders.findIndex(o => o.id === currentBudgetOrderId);
            if (index !== -1) {
                db.orders[index].budget = { service, value, notes };
                saveDB();
                renderOrders(); // Atualiza a lista para mostrar indicador
                toggleModal('modal-budget');
                alert("Or√ßamento salvo!");
            }
        }

        function saveAndSendBudget() {
            if(!currentBudgetOrderId) return;
            // Salva primeiro
            const service = document.getElementById('budget-service').value;
            const value = document.getElementById('budget-value').value;
            const notes = document.getElementById('budget-notes').value;
            
            const index = db.orders.findIndex(o => o.id === currentBudgetOrderId);
            if (index !== -1) {
                db.orders[index].budget = { service, value, notes };
                saveDB();
                renderOrders();
                toggleModal('modal-budget');
                // Envia
                sendBudgetWhatsApp(currentBudgetOrderId);
            }
        }

        function sendBudgetWhatsApp(orderId) {
            const order = db.orders.find(o => o.id == orderId);
            const client = db.clients.find(c => c.id == order.clientId) || {};
            const company = db.company;
            const phone = client.phone.replace(/\D/g, '');
            
            if (phone.length < 10) return alert("Telefone inv√°lido.");

            const text = `*${company.name} - Or√ßamento*\n\n` +
                `Ol√° *${client.name}*! Segue or√ßamento para seu aparelho:\n\n` +
                `üìã *OS:* #${order.id}\n` +
                `üíª *Equipamento:* ${order.device}\n` +
                `‚ö†Ô∏è *Defeito:* ${order.defect}\n\n` +
                `üí∞ *OR√áAMENTO PROPOSTO*\n` +
                `üîß *Servi√ßo:* ${order.budget.service}\n` +
                `üí≤ *Valor Total:* R$ ${order.budget.value}\n` +
                `üìù *Obs:* ${order.budget.notes}\n\n` +
                `Aguardamos sua aprova√ß√£o!`;

            window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(text)}`, '_blank');
        }

        // --- FUN√á√ïES DE A√á√ÉO (IMPRIMIR / WHATSAPP) ---
        function printOrder(orderId) {
            const order = db.orders.find(o => o.id == orderId);
            const client = db.clients.find(c => c.id == order.clientId) || {};
            const company = db.company;

            const printContent = `
                <div style="border: 1px solid #000; padding: 40px; font-family: 'Arial', sans-serif; max-width: 800px; margin: 0 auto; color: #000;">
                    
                    <!-- CABE√áALHO EMPRESA -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 20px;">
                        <h1 style="margin: 0; font-size: 24px; font-weight: bold; text-transform: uppercase;">${company.name}</h1>
                        <p style="margin: 5px 0; font-size: 14px;">${company.address}</p>
                        <p style="margin: 5px 0; font-size: 14px; font-weight: bold;">Tel: ${company.phone}</p>
                    </div>
                    
                    <!-- NUMERO OS E DATA -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border: 1px solid #000; padding: 10px; background-color: #f0f0f0;">
                        <div>
                            <span style="font-size: 18px; font-weight: bold;">ORDEM DE SERVI√áO N¬∫: ${order.id}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 14px;">DATA DE ENTRADA: <strong>${order.date}</strong></span>
                            <br>
                            <span style="font-size: 14px;">STATUS ATUAL: <strong>${order.status.toUpperCase()}</strong></span>
                        </div>
                    </div>

                    <!-- DADOS DO CLIENTE -->
                    <div style="margin-bottom: 15px;">
                        <h3 style="margin: 0 0 5px 0; font-size: 14px; border-bottom: 1px solid #ccc; text-transform: uppercase;">Dados do Cliente</h3>
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 4px; width: 60%;"><strong>Nome:</strong> ${client.name}</td>
                                <td style="padding: 4px;"><strong>CPF/CNPJ:</strong> ${client.document || 'N√£o informado'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px;"><strong>Telefone:</strong> ${client.phone}</td>
                                <td style="padding: 4px;"><strong>Email:</strong> ${client.email || '-'}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- DADOS DO EQUIPAMENTO -->
                    <div style="margin-bottom: 15px;">
                        <h3 style="margin: 0 0 5px 0; font-size: 14px; border-bottom: 1px solid #ccc; text-transform: uppercase;">Equipamento</h3>
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 4px; width: 60%;"><strong>Modelo/Equipamento:</strong> ${order.device}</td>
                                <td style="padding: 4px;"><strong>N¬∫ de S√©rie:</strong> ${order.serial || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px;" colspan="2"><strong>Acess√≥rios Deixados:</strong> ${order.accessories || 'Nenhum'}</td>
                            </tr>
                            ${order.password ? `<tr><td style="padding: 4px;" colspan="2"><strong>Senha do Sistema:</strong> ${order.password}</td></tr>` : ''}
                        </table>
                    </div>

                    <!-- DEFEITO RELATADO -->
                    <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
                        <h3 style="margin: 0 0 5px 0; font-size: 14px; text-transform: uppercase;">Defeito Relatado / Observa√ß√µes</h3>
                        <p style="font-size: 13px; margin: 0;">${order.defect}</p>
                    </div>

                    <!-- OR√áAMENTO (SE HOUVER) -->
                    ${order.budget ? `
                    <div style="margin-bottom: 20px; border: 1px dashed #000; padding: 10px; background-color: #fffff0;">
                        <h3 style="margin: 0 0 5px 0; font-size: 14px; text-transform: uppercase;">Or√ßamento / Servi√ßo</h3>
                        <p style="font-size: 12px; margin: 2px 0;"><strong>Servi√ßo:</strong> ${order.budget.service}</p>
                        <p style="font-size: 12px; margin: 2px 0;"><strong>Valor:</strong> R$ ${order.budget.value}</p>
                        <p style="font-size: 12px; margin: 2px 0;"><strong>Obs:</strong> ${order.budget.notes}</p>
                    </div>` : ''}

                    <!-- TERMOS E CONDI√á√ïES (TEXTO SOLICITADO) -->
                    <div style="margin-bottom: 30px; font-size: 10px; text-align: justify; line-height: 1.4; border-top: 2px solid #000; padding-top: 10px;">
                        <strong>CONDI√á√ïES DE SERVI√áOS:</strong><br>
                        A Empresa d√° garantia de 90 dias para m√£o de obra e pe√ßas usadas no conserto, contados a partir da data de autoriza√ß√£o do servi√ßo. INICIA QUANDO O SERVI√áO ESTIVER PRONTO.<br><br>
                        Os aparelhos n√£o retirados no prazo de 60 dias da data de entrada, ser√° cobrada uma taxa de armazenamento di√°ria (R$ 5,00, cinco Reais).<br>
                        Ap√≥s, ser√° enviado para um dep√≥sito. Durante o per√≠odo de armazenamento o equipamento pode sofrer danos naturais.<br><br>
                        Ao ligar para a Empresa Prestadora de Servi√ßo, informe o n√∫mero da Ordem de Servi√ßo para melhor atend√™-lo. Qualquer d√∫vida que venha a ter com rela√ß√£o ao servi√ßo entre em contato!<br><br>
                        <strong>OS APARELHOS DEIXADOS NA INFOSUPRI POR MAIS DE 90 DIAS SER√ÉO DESPACHADOS PARA TIRAR OS CUSTOS.</strong>
                    </div>

                    <!-- ASSINATURAS -->
                    <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                        <div style="text-align: center; width: 45%;">
                            <div style="border-top: 1px solid #000; margin-bottom: 5px;"></div>
                            Assinatura da Infosupri
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <div style="border-top: 1px solid #000; margin-bottom: 5px;"></div>
                            Assinatura do Cliente
                            <div style="font-size: 10px; margin-top: 2px;">Declaro estar ciente das condi√ß√µes acima.</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('printable-area').innerHTML = printContent;
            window.print();
        }

        function sendWhatsApp(orderId) {
            const order = db.orders.find(o => o.id == orderId);
            const client = db.clients.find(c => c.id == order.clientId) || {};
            const company = db.company;
            const phone = client.phone.replace(/\D/g, '');
            
            if (phone.length < 10) {
                alert("O telefone do cliente parece inv√°lido para WhatsApp.");
                return;
            }

            const text = `*${company.name} - Ordem de Servi√ßo*\n\n` +
                `Ol√° *${client.name}*! Aqui est√£o os detalhes da sua OS:\n\n` +
                `üìã *OS:* #${order.id}\n` +
                `üìÖ *Data:* ${order.date}\n` +
                `üíª *Equipamento:* ${order.device}\n` +
                `‚ö†Ô∏è *Defeito:* ${order.defect}\n` +
                `üìä *Status:* ${order.status.toUpperCase()}\n\n` +
                `${company.footer}`;

            const url = `https://wa.me/55${phone}?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // --- BACKUP ---
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "backup_techfix.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function restoreBackup(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    db = JSON.parse(e.target.result);
                    saveDB();
                    alert("Dados restaurados!");
                    location.reload();
                } catch(err) { alert("Erro no arquivo."); }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if(confirm("Apagar TUDO?")) { localStorage.removeItem(DB_KEY); location.reload(); }
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('dash-open-count').innerText = db.orders.length;
            document.getElementById('dash-ready-count').innerText = db.orders.filter(o => o.status === 'pronto').length;
            document.getElementById('dash-client-count').innerText = db.clients.length;
        }

        renderDashboard();
    </script>
</body>
</html>