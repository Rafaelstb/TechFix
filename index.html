<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechFix Cloud - Gestão Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos de Impressão */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; left: 0; top: 0; width: 100%; 
                margin: 0; padding: 20px; display: block !important; 
                background-color: white; z-index: 9999;
            }
            .no-print { display: none !important; }
        }
        .nav-btn.active { background-color: #1e293b; border-left: 4px solid #2563eb; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden">

    <div id="printable-area" class="hidden bg-white text-black p-8"></div>

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col hidden md:flex no-print">
        <div class="p-6 flex flex-col items-center border-b border-slate-700">
            <div class="flex items-center gap-3 w-full justify-center mb-4">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-wrench"></i></div>
                <h1 class="text-xl font-bold">TechFix</h1>
            </div>
            <div id="sidebar-logo-container" class="w-full flex justify-center min-h-[50px] items-center">
                <div class="text-[10px] text-slate-500 border border-slate-700 border-dashed p-2 rounded w-full text-center uppercase tracking-widest">
                    Cloud Ativo
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="window.showPage('dashboard')" id="nav-dashboard" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition active">
                <i class="fas fa-chart-line w-6 text-center"></i> Visão Geral
            </button>
            <button onclick="window.showPage('clients')" id="nav-clients" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                <i class="fas fa-users w-6 text-center"></i> Clientes
            </button>
            <button onclick="window.showPage('orders')" id="nav-orders" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                <i class="fas fa-laptop-medical w-6 text-center"></i> Ordens (OS)
            </button>
            <button onclick="window.showPage('financial')" id="nav-financial" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition text-green-400 hover:text-green-300">
                <i class="fas fa-dollar-sign w-6 text-center"></i> Financeiro
            </button>
            <hr class="border-slate-700 my-2">
            <button onclick="window.showPage('settings')" id="nav-settings" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition text-slate-400 hover:text-white">
                <i class="fas fa-cog w-6 text-center"></i> Configurações
            </button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-auto no-print">
        <header class="bg-white p-6 shadow-sm flex justify-between items-center border-b">
            <h2 id="page-title" class="text-2xl font-bold text-gray-700">Visão Geral</h2>
            <div class="flex items-center gap-4">
                <div id="connection-status" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full animate-pulse uppercase font-bold border border-yellow-200">Conectando...</div>
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold uppercase border-2 border-blue-200">TF</div>
            </div>
        </header>

        <div class="p-6 flex-1 overflow-auto">
            
            <!-- DASHBOARD -->
            <div id="dashboard" class="page fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                        <div>
                            <p class="text-gray-500 text-sm font-bold uppercase">OS Abertas</p>
                            <p class="text-3xl font-black" id="dash-open-count">0</p>
                        </div>
                        <i class="fas fa-clipboard-list text-3xl text-blue-200"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex justify-between items-center">
                        <div>
                            <p class="text-gray-500 text-sm font-bold uppercase">Prontos</p>
                            <p class="text-3xl font-black" id="dash-ready-count">0</p>
                        </div>
                        <i class="fas fa-check-circle text-3xl text-green-200"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500 flex justify-between items-center">
                        <div>
                            <p class="text-gray-500 text-sm font-bold uppercase">Total Clientes</p>
                            <p class="text-3xl font-black" id="dash-client-count">0</p>
                        </div>
                        <i class="fas fa-users text-3xl text-purple-200"></i>
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                    <h3 class="font-bold text-blue-800 mb-1">Painel Sincronizado</h3>
                    <p class="text-sm text-blue-600">As suas Ordens de Serviço e Clientes agora são guardados na nuvem e atualizados em tempo real.</p>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clients" class="page hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div class="relative w-64">
                        <input type="text" id="search-client" oninput="window.renderClients()" placeholder="Procurar cliente..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                    </div>
                    <button onclick="window.openModal('modal-client')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-bold shadow-lg">
                        <i class="fas fa-plus mr-2"></i> NOVO CLIENTE
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr><th class="p-4">Nome</th><th class="p-4">Telefone</th><th class="p-4 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="clients-list" class="divide-y text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- ORDENS -->
            <div id="orders" class="page hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div class="relative w-64">
                        <input type="text" id="search-order" oninput="window.renderOrders()" placeholder="Procurar OS..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                    </div>
                    <button onclick="window.openOrderModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-bold shadow-lg">
                        <i class="fas fa-plus mr-2"></i> NOVA ORDEM
                    </button>
                </div>
                <div id="orders-list" class="grid grid-cols-1 gap-4"></div>
            </div>

            <!-- FINANCEIRO -->
            <div id="financial" class="page hidden fade-in">
                <div class="bg-white p-6 rounded-xl shadow-sm border mb-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-gray-500 font-bold uppercase text-xs mb-1">Lucro Efetivado (Entregues)</h3>
                        <h2 class="text-4xl font-black text-green-600" id="fin-total">R$ 0,00</h2>
                    </div>
                    <i class="fas fa-chart-pie text-5xl text-green-100"></i>
                </div>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr><th class="p-4">Equipamento</th><th class="p-4 text-right">Lucro</th></tr>
                        </thead>
                        <tbody id="financial-list" class="divide-y text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- CONFIGURAÇÕES -->
            <div id="settings" class="page hidden fade-in space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-bold mb-4">Configuração Cloud</h3>
                    <p class="text-sm text-gray-500 mb-4">Os seus dados estão vinculados ao projeto: <code class="bg-gray-100 p-1 rounded" id="debug-project-id">---</code></p>
                    <button onclick="location.reload()" class="bg-slate-800 text-white px-6 py-2 rounded font-bold hover:bg-slate-700 transition">Reiniciar Ligação</button>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAIS -->
    <div id="modal-client" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4">Registar Novo Cliente</h3>
            <form onsubmit="window.saveClient(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nome do Cliente</label>
                    <input type="text" id="c-name" placeholder="Ex: João Silva" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">WhatsApp / Telefone</label>
                    <input type="text" id="c-phone" placeholder="9xxxxxxxx" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition uppercase tracking-wide">Salvar Cliente</button>
                <button type="button" onclick="window.closeModal('modal-client')" class="w-full text-gray-400 mt-2 text-sm">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="modal-order" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <h3 class="font-bold text-lg mb-4">Lançar Ordem de Serviço</h3>
            <form onsubmit="window.saveOrder(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Selecionar Cliente</label>
                    <select id="os-client-select" required class="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Aparelho</label>
                    <input type="text" id="os-device" placeholder="Ex: iPhone 11 Pro" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Custo da Peça</label>
                        <input type="number" step="0.01" id="os-cost" placeholder="0.00" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Preço Total</label>
                        <input type="number" step="0.01" id="os-price" placeholder="0.00" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Descrição do Problema</label>
                    <textarea id="os-problem" placeholder="Relate o defeito aqui..." class="w-full p-2 border rounded h-24 focus:ring-2 focus:ring-blue-500 outline-none" required></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition uppercase tracking-wide">Criar OS na Nuvem</button>
                <button type="button" onclick="window.closeModal('modal-order')" class="w-full text-gray-400 mt-2 text-sm">Voltar</button>
            </form>
        </div>
    </div>

    <!-- FIREBASE CLOUD SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAÇÕES FIREBASE DINÂMICAS DO AMBIENTE
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "", 
                authDomain: "techfix-8cb67.firebaseapp.com",
                projectId: "techfix-8cb67",
                storageBucket: "techfix-8cb67.firebasestorage.app",
                messagingSenderId: "309298677524",
                appId: "1:309298677524:web:eec6a50678bfaefbe9e401"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'techfix-8cb67';
        document.getElementById('debug-project-id').innerText = appId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbFirestore = getFirestore(app);

        let localDb = { clients: [], orders: [] };
        let userUid = null;

        // --- INICIALIZAÇÃO DE AUTENTICAÇÃO ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (err) {
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        };

        // Escuta mudanças no estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUid = user.uid;
                const status = document.getElementById('connection-status');
                status.innerText = "● Cloud Sync Ativo";
                status.className = "text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full uppercase font-bold animate-none border border-green-200";
                startSync();
            } else {
                initAuth();
            }
        });

        // --- SINCRONIZAÇÃO EM TEMPO REAL ---
        function startSync() {
            if (!userUid) return;

            // MANDATORY RULE 1: Strict paths /artifacts/{appId}/users/{userId}/{collectionName}
            const clientsRef = collection(dbFirestore, 'artifacts', appId, 'users', userUid, 'clients');
            const ordersRef = collection(dbFirestore, 'artifacts', appId, 'users', userUid, 'orders');

            // Escutar Clientes
            onSnapshot(clientsRef, (snap) => {
                localDb.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.renderClients();
                updateClientSelect();
                window.renderDashboard();
            }, (err) => {
                console.error("Erro sync clientes:", err);
            });

            // Escutar Ordens
            onSnapshot(ordersRef, (snap) => {
                localDb.orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.renderOrders();
                window.renderDashboard();
                window.renderFinancial();
            }, (err) => {
                console.error("Erro sync ordens:", err);
            });
        }

        // --- FUNÇÕES GLOBAIS (WINDOW) ---
        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const navBtn = document.getElementById(`nav-${id}`);
            if (navBtn) navBtn.classList.add('active');
            const titles = { dashboard: 'Visão Geral', clients: 'Gestão de Clientes', orders: 'Ordens (OS)', financial: 'Financeiro', settings: 'Configurações' };
            document.getElementById('page-title').innerText = titles[id] || 'TechFix';
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // SALVAR CLIENTE
        window.saveClient = async (e) => {
            e.preventDefault();
            if (!userUid) return alert("Aguarde a ligação Cloud...");

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "A SALVAR...";
            btn.disabled = true;

            try {
                const data = {
                    name: document.getElementById('c-name').value,
                    phone: document.getElementById('c-phone').value,
                    ts: Date.now()
                };
                // SALVAR USANDO O CAMINHO CORRETO
                await addDoc(collection(dbFirestore, 'artifacts', appId, 'users', userUid, 'clients'), data);
                window.closeModal('modal-client');
                e.target.reset();
            } catch (err) {
                console.error("Erro ao salvar cliente:", err);
                alert("Erro de permissão ou ligação. Verifique os logs.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.openOrderModal = () => {
            if(localDb.clients.length === 0) return alert("Cadastre um cliente primeiro!");
            updateClientSelect();
            window.openModal('modal-order');
        };

        window.saveOrder = async (e) => {
            e.preventDefault();
            if (!userUid) return alert("Aguarde a ligação Cloud...");

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "A LANÇAR...";

            try {
                const sel = document.getElementById('os-client-select');
                const data = {
                    clientId: sel.value,
                    clientName: sel.options[sel.selectedIndex].text,
                    device: document.getElementById('os-device').value,
                    cost: parseFloat(document.getElementById('os-cost').value || 0),
                    price: parseFloat(document.getElementById('os-price').value || 0),
                    problem: document.getElementById('os-problem').value,
                    status: 'aberto',
                    date: new Date().toLocaleDateString('pt-BR'),
                    ts: Date.now()
                };
                // SALVAR USANDO O CAMINHO CORRETO
                await addDoc(collection(dbFirestore, 'artifacts', appId, 'users', userUid, 'orders'), data);
                window.closeModal('modal-order');
            } catch (err) {
                alert("Erro ao criar OS: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "CRIAR OS NA NUVEM";
            }
        };

        window.updateStatus = async (id, status) => {
            if (!userUid) return;
            try {
                await updateDoc(doc(dbFirestore, 'artifacts', appId, 'users', userUid, 'orders', id), { status });
            } catch (err) { alert("Erro ao atualizar status."); }
        };

        window.deleteOrder = async (id) => {
            if (!userUid) return;
            if(confirm("Apagar OS permanentemente da nuvem?")) {
                await deleteDoc(doc(dbFirestore, 'artifacts', appId, 'users', userUid, 'orders', id));
            }
        };

        window.deleteClient = async (id) => {
            if (!userUid) return;
            if(confirm("Apagar cliente?")) {
                await deleteDoc(doc(dbFirestore, 'artifacts', appId, 'users', userUid, 'clients', id));
            }
        };

        // --- RENDERS ---
        window.renderClients = () => {
            const list = document.getElementById('clients-list');
            const search = document.getElementById('search-client').value.toLowerCase();
            const filtered = localDb.clients.filter(c => c.name.toLowerCase().includes(search));
            list.innerHTML = filtered.map(c => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-4 font-bold text-slate-700">${c.name}</td>
                    <td class="p-4 text-slate-500">${c.phone}</td>
                    <td class="p-4 text-right">
                        <button onclick="window.deleteClient('${c.id}')" class="text-red-300 hover:text-red-600 transition p-2"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        window.renderOrders = () => {
            const list = document.getElementById('orders-list');
            const search = document.getElementById('search-order').value.toLowerCase();
            const filtered = localDb.orders.filter(o => o.device.toLowerCase().includes(search) || o.clientName.toLowerCase().includes(search));

            list.innerHTML = filtered.sort((a,b) => b.ts - a.ts).map(o => `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:shadow-md">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-black uppercase">OS Ativa</span>
                            <h4 class="font-bold text-slate-800 text-lg">${o.device}</h4>
                        </div>
                        <p class="text-sm text-gray-500">Cliente: <b>${o.clientName}</b> | Entrada: ${o.date}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <select onchange="window.updateStatus('${o.id}', this.value)" class="text-xs p-2 border rounded font-bold uppercase cursor-pointer ${o.status === 'aberto' ? 'bg-amber-50 text-amber-600' : 'bg-green-50 text-green-600'}">
                            <option value="aberto" ${o.status === 'aberto' ? 'selected' : ''}>Aberto</option>
                            <option value="pronto" ${o.status === 'pronto' ? 'selected' : ''}>Pronto</option>
                            <option value="entregue" ${o.status === 'entregue' ? 'selected' : ''}>Entregue</option>
                        </select>
                        <div class="text-right min-w-[100px]">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Total</p>
                            <p class="font-bold text-slate-800">R$ ${o.price.toFixed(2)}</p>
                        </div>
                        <button onclick="window.deleteOrder('${o.id}')" class="text-red-100 hover:text-red-500 text-lg p-2"><i class="fas fa-times-circle"></i></button>
                    </div>
                </div>
            `).join('') || '<p class="text-center p-12 text-gray-400 italic">Nenhuma OS registada na nuvem.</p>';
        };

        window.renderFinancial = () => {
            const finished = localDb.orders.filter(o => o.status === 'pronto' || o.status === 'entregue');
            const profit = finished.reduce((acc, curr) => acc + (curr.price - curr.cost), 0);
            document.getElementById('fin-total').innerText = `R$ ${profit.toFixed(2)}`;
            document.getElementById('financial-list').innerHTML = finished.map(o => `
                <tr class="border-b hover:bg-green-50"><td class="p-4 font-bold text-slate-700">${o.device}</td><td class="p-4 text-right font-black text-green-600">R$ ${(o.price - o.cost).toFixed(2)}</td></tr>
            `).join('');
        };

        window.renderDashboard = () => {
            document.getElementById('dash-open-count').innerText = localDb.orders.filter(o => o.status === 'aberto').length;
            document.getElementById('dash-ready-count').innerText = localDb.orders.filter(o => o.status === 'pronto').length;
            document.getElementById('dash-client-count').innerText = localDb.clients.length;
        };

        function updateClientSelect() {
            const sel = document.getElementById('os-client-select');
            if(!sel) return;
            sel.innerHTML = '<option value="">Selecionar Cliente...</option>' + localDb.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
    </script>
</body>
</html>